<?php
/**
 * Generated by Haxe 4.0.2
 */

namespace haxe\format;

use \php\_Boot\HxAnon;
use \php\Boot;
use \php\_Boot\HxClosure;
use \haxe\ds\StringMap;
use \php\_NativeIndexedArray\NativeIndexedArrayIterator;

/**
 * An implementation of JSON printer in Haxe.
 * This class is used by `haxe.Json` when native JSON implementation
 * is not available.
 * @see https://haxe.org/manual/std-Json-encoding.html
 */
class JsonPrinter {
	/**
	 * @var \StringBuf
	 */
	public $buf;
	/**
	 * @var string
	 */
	public $indent;
	/**
	 * @var int
	 */
	public $nind;
	/**
	 * @var bool
	 */
	public $pretty;
	/**
	 * @var \Closure
	 */
	public $replacer;

	/**
	 * Encodes `o`'s value and returns the resulting JSON string.
	 * If `replacer` is given and is not null, it is used to retrieve
	 * actual object to be encoded. The `replacer` function takes two parameters,
	 * the key and the value being encoded. Initial key value is an empty string.
	 * If `space` is given and is not null, the result will be pretty-printed.
	 * Successive levels will be indented by this string.
	 * 
	 * @param mixed $o
	 * @param \Closure $replacer
	 * @param string $space
	 * 
	 * @return string
	 */
	public static function print ($o, $replacer = null, $space = null) {
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:45: characters 3-50
		$printer = new JsonPrinter($replacer, $space);
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:46: characters 3-23
		$printer->write("", $o);
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:47: characters 3-32
		return $printer->buf->b;
	}

	/**
	 * @param \Closure $replacer
	 * @param string $space
	 * 
	 * @return void
	 */
	public function __construct ($replacer, $space) {
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:57: characters 3-27
		$this->replacer = $replacer;
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:58: characters 3-22
		$this->indent = $space;
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:59: characters 3-30
		$this->pretty = $space !== null;
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:60: characters 3-16
		$this->nind = 0;
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:67: characters 3-24
		$this->buf = new \StringBuf();
	}

	/**
	 * @param mixed $v
	 * 
	 * @return void
	 */
	public function classString ($v) {
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:158: characters 3-60
		$this->fieldsString($v, \Type::getInstanceFields(\Type::getClass($v)));
	}

	/**
	 * @param mixed $v
	 * @param \Array_hx $fields
	 * 
	 * @return void
	 */
	public function fieldsString ($v, $fields) {
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:166: characters 3-20
		$_this = $this->buf;
		$_this->b = ($_this->b??'null') . (mb_chr(123)??'null');

		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:167: characters 3-27
		$len = $fields->length;
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:168: characters 3-22
		$last = $len - 1;
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:169: characters 3-20
		$first = true;
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:170: lines 170-192
		$_g = 0;
		$_g1 = $len;
		while ($_g < $_g1) {
			$i = $_g++;
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:171: characters 4-22
			$f = ($fields->arr[$i] ?? null);
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:172: characters 4-36
			$value = \Reflect::field($v, $f);
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:173: characters 8-33
			$f1 = $value;
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:173: lines 173-174
			if (($f1 instanceof \Closure) || ($f1 instanceof HxClosure)) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:174: characters 5-13
				continue;
			}
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:175: lines 175-179
			if ($first) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:176: characters 5-11
				$this->nind++;
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:177: characters 5-18
				$first = false;
			} else {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:179: characters 5-22
				$_this1 = $this->buf;
				$_this1->b = ($_this1->b??'null') . (mb_chr(44)??'null');
			}
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:180: characters 4-10
			if ($this->pretty) {
				$_this2 = $this->buf;
				$_this2->b = ($_this2->b??'null') . (mb_chr(10)??'null');
			}
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:181: characters 4-10
			if ($this->pretty) {
				$v1 = \StringTools::lpad("", $this->indent, $this->nind * mb_strlen($this->indent));
				$this->buf->add($v1);
			}
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:182: characters 4-12
			$this->quote($f);
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:183: characters 4-21
			$_this3 = $this->buf;
			$_this3->b = ($_this3->b??'null') . (mb_chr(58)??'null');

			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:184: lines 184-185
			if ($this->pretty) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:185: characters 5-22
				$_this4 = $this->buf;
				$_this4->b = ($_this4->b??'null') . (mb_chr(32)??'null');
			}
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:186: characters 4-19
			$this->write($f, $value);
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:187: lines 187-191
			if ($i === $last) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:188: characters 5-11
				$this->nind--;
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:189: characters 5-11
				if ($this->pretty) {
					$_this5 = $this->buf;
					$_this5->b = ($_this5->b??'null') . (mb_chr(10)??'null');
				}
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:190: characters 5-11
				if ($this->pretty) {
					$v2 = \StringTools::lpad("", $this->indent, $this->nind * mb_strlen($this->indent));
					$this->buf->add($v2);
				}
			}
		}

		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:193: characters 3-20
		$_this6 = $this->buf;
		$_this6->b = ($_this6->b??'null') . (mb_chr(125)??'null');

	}

	/**
	 * @param string $s
	 * 
	 * @return void
	 */
	public function quote ($s) {
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:203: characters 3-20
		$_this = $this->buf;
		$_this->b = ($_this->b??'null') . (mb_chr(34)??'null');

		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:204: characters 3-13
		$i = 0;
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:208: lines 208-252
		while (true) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:209: characters 4-43
			$c = \StringTools::fastCodeAt($s, $i++);
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:210: lines 210-211
			if ($c === 0) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:211: characters 5-10
				break;
			}
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:212: lines 212-251
			if ($c === 8) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:224: characters 6-16
				$this->buf->add("\\b");
			} else if ($c === 9) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:222: characters 6-16
				$this->buf->add("\\t");
			} else if ($c === 10) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:218: characters 6-16
				$this->buf->add("\\n");
			} else if ($c === 12) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:226: characters 6-16
				$this->buf->add("\\f");
			} else if ($c === 13) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:220: characters 6-16
				$this->buf->add("\\r");
			} else if ($c === 34) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:214: characters 6-16
				$this->buf->add("\\\"");
			} else if ($c === 92) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:216: characters 6-17
				$this->buf->add("\\\\");
			} else {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:249: characters 6-16
				$_this1 = $this->buf;
				$_this1->b = ($_this1->b??'null') . (mb_chr($c)??'null');
			}
		}
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:257: characters 3-20
		$_this2 = $this->buf;
		$_this2->b = ($_this2->b??'null') . (mb_chr(34)??'null');

	}

	/**
	 * @param mixed $k
	 * @param mixed $v
	 * 
	 * @return void
	 */
	public function write ($k, $v) {
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:82: lines 82-83
		if ($this->replacer !== null) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:83: characters 4-22
			$v = ($this->replacer)($k, $v);
		}
		#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:84: characters 11-25
		$_g = \Type::typeof($v);
		$__hx__switch = ($_g->index);
		if ($__hx__switch === 0) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:136: characters 5-16
			$this->buf->add("null");
		} else if ($__hx__switch === 1) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:90: characters 5-53
			$this->buf->add($v);
		} else if ($__hx__switch === 2) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:92: characters 5-51
			$v1 = (is_finite($v) ? \Std::string($v) : "null");
			$this->buf->add($v1);
		} else if ($__hx__switch === 3) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:134: characters 5-69
			$this->buf->add(($v ? "true" : "false"));
		} else if ($__hx__switch === 4) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:88: characters 5-17
			$this->fieldsString($v, \Reflect::fields($v));
		} else if ($__hx__switch === 5) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:94: characters 5-19
			$this->buf->add("\"<fun>\"");
		} else if ($__hx__switch === 6) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:95: characters 16-17
			$c = $_g->params[0];
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:96: lines 96-129
			if ($c === Boot::getClass('String')) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:97: characters 6-14
				$this->quote($v);
			} else if ($c === Boot::getClass(\Array_hx::class)) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:99: characters 6-31
				$v2 = $v;
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:100: characters 6-23
				$_this = $this->buf;
				$_this->b = ($_this->b??'null') . (mb_chr(91)??'null');

				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:102: characters 6-25
				$len = $v2->length;
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:103: characters 6-25
				$last = $len - 1;
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:104: lines 104-117
				$_g1 = 0;
				$_g11 = $len;
				while ($_g1 < $_g11) {
					$i = $_g1++;
					#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:105: lines 105-108
					if ($i > 0) {
						#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:106: characters 8-25
						$_this1 = $this->buf;
						$_this1->b = ($_this1->b??'null') . (mb_chr(44)??'null');
					} else {
						#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:108: characters 8-14
						$this->nind++;
					}
					#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:109: characters 7-13
					if ($this->pretty) {
						$_this2 = $this->buf;
						$_this2->b = ($_this2->b??'null') . (mb_chr(10)??'null');
					}
					#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:110: characters 7-13
					if ($this->pretty) {
						$v3 = \StringTools::lpad("", $this->indent, $this->nind * mb_strlen($this->indent));
						$this->buf->add($v3);
					}
					#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:111: characters 7-21
					$this->write($i, ($v2->arr[$i] ?? null));
					#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:112: lines 112-116
					if ($i === $last) {
						#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:113: characters 8-14
						$this->nind--;
						#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:114: characters 8-14
						if ($this->pretty) {
							$_this3 = $this->buf;
							$_this3->b = ($_this3->b??'null') . (mb_chr(10)??'null');
						}
						#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:115: characters 8-14
						if ($this->pretty) {
							$v4 = \StringTools::lpad("", $this->indent, $this->nind * mb_strlen($this->indent));
							$this->buf->add($v4);
						}
					}
				}

				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:118: characters 6-23
				$_this4 = $this->buf;
				$_this4->b = ($_this4->b??'null') . (mb_chr(93)??'null');

			} else if ($c === Boot::getClass(StringMap::class)) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:120: characters 6-43
				$v5 = $v;
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:121: characters 6-17
				$o = new HxAnon();
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:122: characters 16-24
				$k1 = new NativeIndexedArrayIterator(array_values(array_map("strval", array_keys($v5->data))));
				while ($k1->hasNext()) {
					#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:122: lines 122-123
					$k2 = $k1->next();
					#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:123: characters 7-39
					\Reflect::setField($o, $k2, ($v5->data[$k2] ?? null));
				}

				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:124: characters 6-18
				$v6 = $o;
				$this->fieldsString($v6, \Reflect::fields($v6));

			} else if ($c === Boot::getClass(\Date::class)) {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:126: characters 6-21
				$v7 = $v;
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:127: characters 6-25
				$this->quote($v7->toString());
			} else {
				#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:129: characters 6-20
				$this->classString($v);
			}
		} else if ($__hx__switch === 7) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:130: characters 15-16
			$_g12 = $_g->params[0];
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:131: characters 5-39
			$i1 = $v->index;
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:132: characters 5-11
			$this->buf->add($i1);

		} else if ($__hx__switch === 8) {
			#/usr/share/haxe/std/haxe/format/JsonPrinter.hx:86: characters 5-17
			$this->buf->add("\"???\"");
		}

	}
}

Boot::registerClass(JsonPrinter::class, 'haxe.format.JsonPrinter');
