<?php
/**
 * Generated by Haxe 4.0.2
 */

namespace sys\io;

use \sys\io\_Process\WritablePipe;
use \php\Boot;
use \haxe\io\Output;
use \haxe\io\Error;
use \haxe\io\Input;
use \php\_Boot\HxException;
use \haxe\SysTools;
use \sys\io\_Process\ReadablePipe;

class Process {
	/**
	 * @var int
	 */
	public $_exitCode;
	/**
	 * @var int
	 */
	public $pid;
	/**
	 * @var mixed
	 */
	public $pipes;
	/**
	 * @var mixed
	 */
	public $process;
	/**
	 * @var bool
	 */
	public $running;
	/**
	 * @var Input
	 */
	public $stderr;
	/**
	 * @var Output
	 */
	public $stdin;
	/**
	 * @var Input
	 */
	public $stdout;

	/**
	 * @param string $cmd
	 * @param \Array_hx $args
	 * @param bool $detached
	 * 
	 * @return void
	 */
	public function __construct ($cmd, $args = null, $detached = null) {
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:125: characters 22-24
		$this->_exitCode = -1;
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:124: characters 21-25
		$this->running = true;
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:123: characters 16-18
		$this->pid = -1;
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:128: lines 128-129
		if ($detached) {
			#/usr/share/haxe/std/php/_std/sys/io/Process.hx:129: characters 4-9
			throw new HxException("Detached process is not supported on this platform");
		}
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:130: characters 3-131
		$descriptors = [["pipe", "r"], ["pipe", "w"], ["pipe", "w"]];
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:131: characters 3-66
		$result = proc_open($this->buildCmd($cmd, $args), $descriptors, $this->pipes);
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:132: lines 132-133
		if ($result === false) {
			#/usr/share/haxe/std/php/_std/sys/io/Process.hx:133: characters 4-9
			throw new HxException(Error::Custom("Failed to start process: " . ($cmd??'null')));
		}
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:134: characters 3-19
		$this->process = $result;
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:136: characters 3-17
		$this->updateStatus();
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:138: characters 3-40
		$this->stdin = new WritablePipe($this->pipes[0]);
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:139: characters 3-42
		$this->stdout = new ReadablePipe($this->pipes[1]);
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:140: characters 3-42
		$this->stderr = new ReadablePipe($this->pipes[2]);
	}

	/**
	 * @param string $cmd
	 * @param \Array_hx $args
	 * 
	 * @return string
	 */
	public function buildCmd ($cmd, $args = null) {
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:174: lines 174-175
		if ($args === null) {
			#/usr/share/haxe/std/php/_std/sys/io/Process.hx:175: characters 4-14
			return $cmd;
		}
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:177: characters 18-34
		if (\Sys::systemName() === "Windows") {
			#/usr/share/haxe/std/php/_std/sys/io/Process.hx:179: characters 5-82
			$_this = (\Array_hx::wrap([\StringTools::replace($cmd, "/", "\\")]))->concat($args);
			$result = [];
			$data = $_this->arr;
			$_g_current = 0;
			$_g_length = count($data);
			$_g_data = $data;
			while ($_g_current < $_g_length) {
				$item = $_g_data[$_g_current++];
				$result[] = SysTools::quoteWinArg($item, true);
			}

			#/usr/share/haxe/std/php/_std/sys/io/Process.hx:179: characters 5-92
			return \Array_hx::wrap($result)->join(" ");
		} else {
			#/usr/share/haxe/std/php/_std/sys/io/Process.hx:181: characters 5-50
			$_this1 = (\Array_hx::wrap([$cmd]))->concat($args);
			$f = Boot::getStaticClosure(SysTools::class, 'quoteUnixArg');
			$result1 = [];
			$data1 = $_this1->arr;
			$_g_current1 = 0;
			$_g_length1 = count($data1);
			$_g_data1 = $data1;
			while ($_g_current1 < $_g_length1) {
				$item1 = $_g_data1[$_g_current1++];
				$result1[] = $f($item1);
			}

			#/usr/share/haxe/std/php/_std/sys/io/Process.hx:181: characters 5-60
			return \Array_hx::wrap($result1)->join(" ");
		}
	}

	/**
	 * @return void
	 */
	public function updateStatus () {
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:186: lines 186-187
		if (!$this->running) {
			#/usr/share/haxe/std/php/_std/sys/io/Process.hx:187: characters 4-10
			return;
		}
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:189: characters 3-42
		$status = proc_get_status($this->process);
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:190: lines 190-191
		if ($status === false) {
			#/usr/share/haxe/std/php/_std/sys/io/Process.hx:191: characters 4-9
			throw new HxException(Error::Custom("Failed to obtain process status"));
		}
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:192: characters 3-48
		$status1 = $status;
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:194: characters 3-22
		$this->pid = $status1["pid"];
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:195: characters 3-30
		$this->running = $status1["running"];
		#/usr/share/haxe/std/php/_std/sys/io/Process.hx:196: characters 3-33
		$this->_exitCode = $status1["exitcode"];
	}
}

Boot::registerClass(Process::class, 'sys.io.Process');
