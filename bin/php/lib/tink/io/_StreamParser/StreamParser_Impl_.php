<?php
/**
 * Generated by Haxe 4.0.2
 */

namespace tink\io\_StreamParser;

use \php\_Boot\HxAnon;
use \tink\core\_Future\SyncFuture;
use \tink\io\StreamParserObject;
use \php\Boot;
use \tink\io\_Source\Source_Impl_;
use \tink\streams\Single;
use \tink\streams\StreamObject;
use \tink\streams\Handled;
use \tink\core\_Lazy\LazyConst;
use \tink\streams\_Stream\Handler_Impl_;
use \tink\io\ParseResult;
use \tink\core\_Future\Future_Impl_;
use \tink\_Chunk\Chunk_Impl_;
use \tink\core\_Future\FutureObject;

final class StreamParser_Impl_ {
	/**
	 * @param StreamObject $source
	 * @param StreamParserObject $p
	 * @param \Closure $consume
	 * @param \Closure $finish
	 * 
	 * @return FutureObject
	 */
	public static function doParse ($source, $p, $consume, $finish) {
		#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:26: characters 5-39
		$cursor = Chunk_Impl_::$EMPTY->getCursor();
		#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:27: characters 5-23
		$resume = true;
		#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:28: lines 28-33
		$mk = function ($source1)  use (&$cursor) {
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:29: lines 29-32
			if ($cursor->currentPos < $cursor->length) {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:30: characters 9-39
				return $source1->prepend(new Single(new LazyConst($cursor->right())));
			} else {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:32: characters 9-15
				return $source1;
			}
		};
		#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:35: lines 35-39
		$flush = function ()  use (&$cursor) {
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:36: characters 21-35
			$_g = $cursor->flush();
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:37: characters 14-15
			$c = $_g;
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:37: lines 37-38
			if ($c->getLength() === 0) {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:37: characters 35-52
				return Source_Impl_::$EMPTY;
			} else {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:38: characters 14-15
				$c1 = $_g;
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:38: characters 9-18
				return new Single(new LazyConst($c1));
			}
		};
		#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:41: lines 41-84
		$ret = $source->forEach(Handler_Impl_::ofUnknown(function ($chunk)  use (&$consume, &$resume, &$cursor, &$p) {
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:42: characters 7-55
			if ($chunk->getLength() === 0) {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:42: characters 29-55
				return new SyncFuture(new LazyConst(Handled::Resume()));
			}
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:43: characters 7-26
			$cursor->shift($chunk);
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:45: lines 45-65
			return Future_Impl_::async(function ($cb)  use (&$consume, &$resume, &$cursor, &$p) {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:46: lines 46-63
				$next = null;
				$next = function ()  use (&$consume, &$next, &$resume, &$cb, &$cursor, &$p) {
					#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:47: characters 11-25
					$cursor->shift();
					#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:48: characters 11-43
					$lastPos = $cursor->currentPos;
					#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:49: characters 18-36
					$_g1 = $p->progress($cursor);
					$__hx__switch = ($_g1->index);
					if ($__hx__switch === 0) {
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:51: characters 15-107
						if (($lastPos !== $cursor->currentPos) && ($cursor->currentPos < $cursor->length)) {
							#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:51: characters 85-91
							$next();
						} else {
							#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:51: characters 97-107
							$cb(Handled::Resume());
						}
					} else if ($__hx__switch === 1) {
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:52: characters 23-24
						$v = $_g1->params[0];
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:53: lines 53-59
						$consume($v)->handle(function ($o)  use (&$next, &$lastPos, &$resume, &$cb, &$cursor) {
							#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:54: characters 17-34
							$resume = $o->resume;
							#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:55: lines 55-58
							if ($resume) {
								#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:56: characters 19-111
								if (($lastPos !== $cursor->currentPos) && ($cursor->currentPos < $cursor->length)) {
									#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:56: characters 89-95
									$next();
								} else {
									#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:56: characters 101-111
									$cb(Handled::Resume());
								}
							} else {
								#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:58: characters 19-29
								$cb(Handled::Finish());
							}
						});
					} else if ($__hx__switch === 2) {
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:60: characters 25-26
						$e = $_g1->params[0];
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:61: characters 15-26
						$cb(Handled::Clog($e));
					}

				};
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:64: characters 9-15
				$next();
			});
		}))->flatMap(function ($c2)  use (&$finish, &$consume, &$mk, &$flush, &$resume, &$cursor, &$p) {
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:66: lines 66-84
			$__hx__switch = ($c2->index);
			if ($__hx__switch === 0) {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:67: characters 19-23
				$rest = $c2->params[0];
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:68: characters 28-36
				$v1 = $finish();
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:68: characters 9-48
				return new SyncFuture(new LazyConst(ParseResult::Parsed($v1, $mk($rest))));
			} else if ($__hx__switch === 1) {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:69: characters 23-27
				$rest1 = $c2->params[1];
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:69: characters 20-21
				$e1 = $c2->params[0];
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:70: characters 9-42
				return new SyncFuture(new LazyConst(ParseResult::Invalid($e1, $mk($rest1))));
			} else if ($__hx__switch === 2) {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:71: characters 19-20
				$e2 = $c2->params[0];
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:72: characters 9-30
				return new SyncFuture(new LazyConst(ParseResult::Broke($e2)));
			} else if ($__hx__switch === 3) {
				#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:73: lines 73-83
				if ($cursor->currentPos < $cursor->length) {
					#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:74: characters 28-36
					$v2 = $finish();
					#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:74: characters 41-52
					$v3 = new Single(new LazyConst(Chunk_Impl_::$EMPTY));
					#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:74: characters 9-55
					return new SyncFuture(new LazyConst(ParseResult::Parsed($v2, $mk($v3))));
				} else if (!$resume) {
					#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:76: characters 28-36
					$v4 = $finish();
					#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:76: characters 9-47
					return new SyncFuture(new LazyConst(ParseResult::Parsed($v4, $flush())));
				} else {
					#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:78: characters 16-29
					$_g2 = $p->eof($cursor);
					$__hx__switch = ($_g2->index);
					if ($__hx__switch === 0) {
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:79: characters 24-30
						$result = $_g2->params[0];
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:80: characters 13-79
						$ret1 = $consume($result)->map(function ($_)  use (&$finish, &$flush) {
							#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:80: characters 60-68
							$ret2 = $finish();
							#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:80: characters 46-78
							return ParseResult::Parsed($ret2, $flush());
						});
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:80: characters 13-79
						return $ret1->gather();
					} else if ($__hx__switch === 1) {
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:81: characters 24-25
						$e3 = $_g2->params[0];
						#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:82: characters 13-45
						return new SyncFuture(new LazyConst(ParseResult::Invalid($e3, $flush())));
					}
				}
			}
		});
		#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:41: lines 41-84
		return $ret->gather();
	}

	/**
	 * @param StreamObject $s
	 * @param StreamParserObject $p
	 * 
	 * @return FutureObject
	 */
	public static function parse ($s, $p) {
		#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:87: characters 5-20
		$res = null;
		#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:88: lines 88-91
		$onResult = function ($r)  use (&$res) {
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:89: characters 7-14
			$res = $r;
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:90: characters 7-44
			return new SyncFuture(new LazyConst(new HxAnon(["resume" => false])));
		};
		#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:92: characters 5-59
		return StreamParser_Impl_::doParse($s, $p, $onResult, function ()  use (&$res) {
			#/home/jahred/haxelib/tink_io/0,7,1/src/tink/io/StreamParser.hx:92: characters 48-58
			return $res;
		});
	}
}

Boot::registerClass(StreamParser_Impl_::class, 'tink.io._StreamParser.StreamParser_Impl_');
